---
title: "Fig 6: Survival Plots"
output: html_document
date: "2025-08-10"
---

```{r}
library(tidyverse)
library(scales)
library(ggrepel)
library(ggpubr)
```
```{r}

TMA_RISH <- read_csv("data/Fig_1k.csv")
TMA_clinic_data <- read_csv("data/UWTAN_tissue_clinical_info.csv")

TMA_RISH_cleaned <- TMA_RISH %>%
  rename("Sample_ID" = "Image Tag") %>%
  filter(`Included in analysis` == "Y") %>%
  mutate(Sample_ID = str_remove(Sample_ID, "\\d+\\) ")) %>%
  mutate(Patient_ID = str_extract(Sample_ID, "\\d{2}-\\d{3}")) %>%
  mutate(across(matches("area_perc|cell_count"), as.numeric))

TMA_RISH_patient_analysis <- TMA_RISH_cleaned %>%
  group_by(Patient_ID) %>%
  summarise(
    across(c(6:49), mean, na.rm = TRUE),
    .groups = "drop"
  )
TMA_RISH_patient_tissue <- TMA_RISH_cleaned %>%
  group_by(Patient_ID) %>%
  summarise(
    Patient_Cell_Types = paste(unique(`Cell Type`), collapse = ", ")
  )
TMA_compiled_survival <- left_join(TMA_RISH_patient_analysis, TMA_RISH_patient_tissue, by = "Patient_ID") %>%
  left_join(TMA_clinic_data, by = c("Patient_ID" = "Tissue #")) %>%
  mutate(tumor_high_3_4 = `tumor: % ARG-TCT 3+` + `tumor: % ARG-TCT 4+`) %>%
    mutate(tumor_medium_high_2_3_4 = `tumor: % ARG-TCT 2+` + `tumor: % ARG-TCT 3+` + `tumor: % ARG-TCT 4+`) %>%
  mutate_at(vars(54,55,56,57,59,61,64,65,66,67,68,69,70,78,79), as.numeric)

TMA_compiled_survival$Patient_Cell_Types = as.character(TMA_compiled_survival$Patient_Cell_Types)

TMA_compiled_survival %>%
  filter(!is.na(`survival from dx (years)`)) %>%
  ggplot(aes(x = `survival from dx (years)`, y = tumor_medium_high_2_3_4, color = "black")) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", color = "grey", fill = "lightsalmon", se = TRUE) +
  theme_classic() +
  theme(legend.position = "none") +
  theme(axis.title = element_text(size = 12, face = "bold")) +
  labs(x = "Survival from Diagnosis (years)" , y = "Arg-TCT-1-1 Medium+ Intensity", title = "Survival from Diagnosis (years) vs. Arg-TCT-1-1 Medium+ Intensity") +
  stat_cor(aes(color = NULL), method = "spearman", label.sep = "\n", label.x = 0, label.y = 100)

TMA_compiled_survival %>%
  filter(`Androgen Independence to Death (yrs)` != "NA") %>%
  ggplot(aes(x = `Androgen Independence to Death (yrs)`, y = tumor_medium_high_2_3_4, color = "black")) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", color = "grey", fill = "lightsalmon", se = TRUE) +
  theme_classic() +
  theme(legend.position = "none") +
  theme(axis.title = element_text(size = 12, face = "bold")) +
  labs(x = "AI to death (years)" , y = "Arg-TCT-1-1 Medium+ Intensity", title = "AI to death (years) vs. Arg-TCT-1-1 Medium+ intensity") +
  stat_cor(aes(color = NULL), method = "spearman", label.sep = "\n", label.x = 0, label.y = 100)

TMA_compiled_survival %>%
  filter(`ADT - Death (years)` != "NA") %>%
  ggplot(aes(x = `ADT - Death (years)`, y = tumor_medium_high_2_3_4, color = "black")) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", color = "grey", fill = "lightsalmon", se = TRUE) +
  theme_classic() +
  theme(legend.position = "none") +
  theme(axis.title = element_text(size = 12, face = "bold")) +
  labs(x = "ADT to death (years)" , y = "Arg-TCT-1-1 Medium+ Intensity", title = "ADT to death (years) vs. Arg-TCT-1-1 Medium+ intensity") +
  stat_cor(aes(color = NULL), method = "spearman", label.sep = "\n", label.x = 0, label.y = 100)

TMA_compiled_survival %>%
  filter(`Bone Met delay from diagnosis (yrs)` != "NA") %>%
  ggplot(aes(x = `Bone Met delay from diagnosis (yrs)`, y = tumor_medium_high_2_3_4, color = "black")) +
  geom_point(size=3) +
  geom_smooth(method=lm , color="grey", fill="lightsalmon", se=TRUE) +
  xlim(c(0,15)) +
  theme_classic() +
  theme(legend.position = "none") +
  theme(axis.title = element_text(size = 12, face = "bold")) +
  labs(x = "Diagnosis to Bone Mets (years)" , y = "Arg-TCT-1-1 Medium+ Intensity", title = "Diagnosis to Bone Mets (years) vs. Arg-TCT-1-1 Medium+ intensity") +
  stat_cor(aes(color = NULL), method = "spearman", label.sep = "\n", label.x = 0, label.y = 100)
```

